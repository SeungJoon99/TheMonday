<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<!-- Namespace를 통해 JAVA 클래스와 Annotation클래스와 동기 -->
<mapper namespace="com.ezen.shop">

	<!-- ProductVO resultMap -->
	<resultMap type="com.ezen.vo.ProductVO" id="shopItemListMap">
		<id property="pno" column="p_no" />
		<result property="pprice" column="p_price" />
	    <result property="pinfo" column="p_info" />
	    <result property="ppimgname" column="p_pimg_name" />
	    <result property="pname" column="p_name" />
	    <result property="pwdate" column="p_wdate" />
	    <result property="pdisplay" column="p_display" />
	    <result property="pkind" column="p_kind" />
	    <result property="pdelyn" column="p_delyn" />
	</resultMap>
	
	<!-- CartVO resultMap -->
	<resultMap type="com.ezen.vo.CartVO" id="shopCart">
		<id property="uno" column="u_no" />
		<id property="pno" column="p_no" />
		<result property="cqty" column="c_qty" />
		<result property="cwdate" column="c_wdate" />
	</resultMap>
	
	<!-- 상품 목록 조회 -->
	<select id="Main" parameterType="com.ezen.vo.SearchVO"
		resultMap="shopItemListMap">
		select p_no, p_price, p_name, p_pimg_name,
		(select sum(d_qty) from detail d where p_no = p.p_no) sum
		from product p
		where 
		p_delyn = 'N' 
		and p_display = 'Y'
		<if test="pkind != null and pkind.trim() != ''">
			and p_kind = #{ pkind }
		</if>
		order by sum
		limit #{ offset }, 16
	</select>
	
	<!-- 상품 개수  -->
	<select id="total" parameterType="com.ezen.vo.SearchVO"
		resultType="java.lang.Integer">
		select count(*) as total
		from product
		where 
		p_delyn = 'N' 
		and p_display = 'Y'
		<if test='pkind != null and !pkind.equals("")'>
			and p_kind = #{ pkind }
		</if> 
		<if test='keyword != null and !keyword.equals("")'>
			and p_name like CONCAT('%', #{ keyword }, '%')
		</if>
	</select>
	<!-- 상품 단건 조회 -->
	<select id="ProductDetail" parameterType="java.lang.Integer" 
		resultMap="shopItemListMap">
		select p_no, p_price, p_name, p_pimg_name, p_info
		from product p
		where
		p_no = #{ pno } 
		and p_delyn = 'N' 
		and p_display = 'Y' 
	</select>
	
	<!-- 상품 검색 -->
	<select id="Search" parameterType="com.ezen.vo.SearchVO" 
		resultMap="shopItemListMap">
		select p_no, p_price, p_name, p_pimg_name,
		(select sum(d_qty) from detail d where p_no = p.p_no) sum
		from product p
		where 
		p_delyn = 'N' 
		and p_display = 'Y'
		<if test='keyword != null and !keyword.equals("")'>
			and p_name like CONCAT('%', #{ keyword }, '%')
		</if>
		order by sum
		limit #{ offset }, 16
	</select>
	
	<!-- 해당 상품이 있는 지 확인 -->
	<select id="CheckCart" parameterType="com.ezen.vo.CartVO" resultType="int">
    SELECT count(*)
    FROM cart
    WHERE u_no = #{uno} AND p_no = #{pno}
	</select>
	
	<!-- 해당 상품이 이미 있을 경우 -->
	<update id="UpdateCart" parameterType="com.ezen.vo.CartVO">
    UPDATE cart
    SET c_qty = c_qty + 1
    WHERE u_no = #{uno} AND p_no = #{pno}
	</update>

	<!-- 장바구니 담기 -->
	<insert id="AddCart" parameterType="com.ezen.vo.CartVO">
		insert into cart(u_no, p_no)
		value(#{ uno }, #{ pno })
	</insert>
</mapper>
