<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<!-- Namespace를 통해 JAVA 클래스와 Annotation클래스와 동기 -->
<mapper namespace="com.ezen.member">

	<!-- UserVO resultMap -->
	<resultMap type="com.ezen.vo.UserVO" id="userMap">
		<id property="uno" column="u_no" />
		<result property="unick" column="u_nick" />
	    <result property="uemail" column="u_email" />
	    <result property="upw" column="u_pw" />
	    <result property="uhp" column="u_hp" />
	    <result property="utype" column="u_type" />
	    <result property="upostcode" column="u_postcode" />
	    <result property="uold" column="u_old" />
	    <result property="uaddr" column="u_addr" />
	    <result property="uaddr2" column="u_addr2" />
	    <result property="uname" column="u_name" />
	    <result property="udelyn" column="u_delyn" />
	    <result property="uwdate" column="u_wdate" />
	    <result property="uudate" column="u_udate" />
	</resultMap>
	
	<!-- CartVO join ProductVO resultMap -->
	<resultMap type="com.ezen.vo.CartVO" id="memberCart">
	    <id property="uno" column="u_no" />
	    <id property="pno" column="p_no" />
	    <result property="cqty" column="c_qty" />
	    <result property="cwdate" column="c_wdate" />
	
	    <association property="product" javaType="com.ezen.vo.ProductVO">
	        <result property="pno" column="p_no" /> 
	        <result property="ppimgname" column="p_pimg_name" />
	        <result property="pname" column="p_name" />
	        <result property="pprice" column="p_price" />
        </association>
	</resultMap>
	
	<!-- OrdersVO, ProductVO, DetailVO join resultMap -->
	<resultMap type="com.ezen.vo.OrdersVO" id="mypageOrdersList">
		<id property="ono" column="o_no" />
		<result property="uno" column="u_no" />
		<result property="pname" column="p_name" />
		<result property="ototal" column="o_total" />
		<association property="detail" javaType="com.ezen.vo.DetailVO">
	        <id property="pno" column="p_no" /> 
	        <id property="ono" column="o_no" />
	    </association>
	</resultMap>
	
	<!-- OrdersVO resultMap -->
	<resultMap type="com.ezen.vo.OrdersVO" id="shopOrderListMap">
		<id property="ono" column="o_no" />
		<result property="uno" column="u_no" />
		<result property="uhp" column="u_hp" />
		<result property="upostcode" column="u_postcode" />
		<result property="uold" column="u_old" />
		<result property="uaddr" column="u_addr" />
		<result property="uaddr2" column="u_addr2" />
		<result property="orequest" column="o_request" />
		<result property="odate" column="o_date" />
		<result property="ototal" column="o_total" />
		<result property="pname" column="p_name" />
		<result property="svalue" column="s_value" />
		<result property="unick" column="u_nick" />
	</resultMap>
	
	<resultMap type="com.ezen.vo.RecordVO" id="orderrecordlist">
		<id property="ono" column="o_no" />
		<result property="ppimgname" column="p_pimg_name" />
		<result property="pname" column="p_name" />
		<result property="ototal" column="o_total" />
		<result property="odate" column="o_date" />
	</resultMap>
	
	<select id="UnickCheck" parameterType="java.lang.String"
			resultType="java.lang.Integer">
		select count(*) 
		from user
		where
		u_nick = #{ u }		
	</select>
	
	<insert id="Signup" parameterType="com.ezen.vo.UserVO">
		insert into user(u_nick, u_email, u_pw, u_hp, u_postcode, u_addr, u_addr2, u_name)
		values(
		#{ unick }, 
		#{ uemail }, 
		md5(#{ upw }), 
		#{ uhp }, 
		#{ upostcode }, 
		#{ uaddr }, 
		#{ uaddr2 }, 
		#{ uname } 
		)
	</insert>
	
	<select id="login" parameterType="com.ezen.vo.UserVO"
		resultMap="userMap">
		select * 
		from user
		where
		u_delyn = 'N'
		and u_email = #{ uemail }
		and u_pw = md5(#{ upw }) 
	</select>
	
	<select id="Cart" parameterType="com.ezen.vo.UserVO"
		resultMap="memberCart">
		select
		    c.*,                 
		    p.p_pimg_name,       
		    p.p_name,           
		    p.p_price
		from
		    cart c                                     
		inner join
		    product p on c.p_no = p.p_no               
		where
    	c.u_no = #{ uno }
	</select>
	
	<select id="cartTotal" parameterType="com.ezen.vo.UserVO" resultType="java.lang.Integer">
		select
		sum(p.p_price * c.c_qty) carttotal
		from cart c
		inner join product p
		on p.p_no = c.p_no
		where 
		u_no = #{ uno }
	</select>
	
	<insert id="insertIntoOrders" parameterType="com.ezen.vo.UserVO">
		insert into orders(u_no, u_hp, u_postcode, o_total, u_old, u_addr, u_addr2, o_request)
		values(#{ uno }, #{ uhp }, #{ upostcode }, #{ ototal }, #{ uold }, #{ uaddr }, #{ uaddr2 }, #{ orequest })
	</insert>
	
	<delete id="deleteCart" parameterType="com.ezen.vo.UserVO">
		delete from cart where cart c c.u_no = #{ uno }
	</delete>
	
	<select id="selectFromUser" parameterType="com.ezen.vo.UserVO"
		resultMap="userMap">
		select * 
		from user
		where
		u_no = #{ uno }	
	</select>
	
	<update id="deleteUser" parameterType="java.lang.Integer">
		update user
		set
		u_delyn = 'Y'
		where
		u_no = #{ uno }
	</update>
	
	<select id="orderrecordlist" parameterType="java.lang.Integer"
		resultMap="orderrecordlist">
		SELECT o.o_no, p.p_pimg_name, p.p_name, o.o_total, o.o_date from orders o
		join detail d on d.o_no = o.o_no
		join product p on d.p_no = p.p_no
		where o.u_no = #{ uno }
	</select>
	
</mapper>
